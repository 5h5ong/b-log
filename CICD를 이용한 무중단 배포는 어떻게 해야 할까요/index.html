<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" name="google-site-verification" content="hXzBIUorkHEVsO9Jb_mIDuDqsTRSzyOx9rvhZ3GrZj8"/><meta name="generator" content="Gatsby 4.6.2"/><style data-href="/b-log/styles.b776309b4decf2925be2.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;background:none;color:#f8f8f2;font-family:Fira Code,Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2e3440}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#636f88}.token.punctuation{color:#81a1c1}.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#81a1c1}.token.number{color:#b48ead}.token.boolean{color:#81a1c1}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a3be8c}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#81a1c1}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#88c0d0}.token.keyword{color:#81a1c1}.token.important,.token.regex{color:#ebcb8b}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="b:Log Rss Feed" href="/b-log/rss.xml"/><link rel="sitemap" type="application/xml" href="/b-log/sitemap/sitemap-index.xml"/><style data-styled="" data-styled-version="5.3.3">.nvvNn{position:relative;left:100%;padding-left:4rem;line-height:2.25rem;}/*!sc*/
.nvvNn ul{list-style-type:none;padding-left:1rem;}/*!sc*/
.nvvNn li{margin:0px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}/*!sc*/
.nvvNn p{margin:0px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}/*!sc*/
.nvvNn a{--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity));font-size:0.875rem;line-height:1.25rem;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
.nvvNn a:hover{--tw-text-opacity:1;color:rgba(17,24,39,var(--tw-text-opacity));}/*!sc*/
data-styled.g1[id="Toc__Container-sc-9zrjd9-0"]{content:"nvvNn,"}/*!sc*/
.dmEqLl{position:fixed;width:18rem;height:50%;border-radius:1.5rem;padding:1.25rem;overflow-y:auto;box-shadow:20px 20px 60px #d9d9d9,-20px -20px 60px #ffffff;}/*!sc*/
data-styled.g2[id="Toc__Contents-sc-9zrjd9-1"]{content:"dmEqLl,"}/*!sc*/
.jQTdsB{--tw-text-opacity:1;color:rgba(0,0,0,var(--tw-text-opacity));-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
.jQTdsB:hover{--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity));}/*!sc*/
data-styled.g3[id="StyledLink-sc-3uouk6-0"]{content:"jQTdsB,"}/*!sc*/
.rWuXm{font-size:0.875rem;line-height:1.25rem;--tw-text-opacity:1;color:rgba(156,163,175,var(--tw-text-opacity));}/*!sc*/
data-styled.g4[id="Tag__TagStyledLink-sc-1hcx1ww-0"]{content:"rWuXm,"}/*!sc*/
.gOnOul{margin-right:0.5rem;}/*!sc*/
.gOnOul:last-child{margin:0px;}/*!sc*/
data-styled.g5[id="gaps__GapHorizontality-sc-1ekq037-0"]{content:"gOnOul,"}/*!sc*/
.kyIceB{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;font-size:3rem;line-height:1;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;margin-bottom:4rem;}/*!sc*/
data-styled.g6[id="BlogTitle__StyledH1-sc-15e6xzu-0"]{content:"kyIceB,"}/*!sc*/
.evzjD{margin-top:5rem;margin-bottom:8rem;}/*!sc*/
data-styled.g7[id="BlogHeader__HeaderContainer-sc-svto0z-0"]{content:"evzjD,"}/*!sc*/
.AYgxb{margin-top:10rem;margin-bottom:10rem;}/*!sc*/
data-styled.g8[id="blog-post__Container-sc-bktxku-0"]{content:"AYgxb,"}/*!sc*/
.bWWXUD{max-width:768px;margin:auto;}/*!sc*/
data-styled.g9[id="blog-post__SectionContainer-sc-bktxku-1"]{content:"bWWXUD,"}/*!sc*/
.dgABOP{max-width:1024px;margin:auto;margin-bottom:7rem;}/*!sc*/
data-styled.g10[id="blog-post__Header-sc-bktxku-2"]{content:"dgABOP,"}/*!sc*/
.kmNTJS{margin-bottom:0px;font-size:3.75rem;line-height:1;}/*!sc*/
data-styled.g11[id="blog-post__PostTitle-sc-bktxku-3"]{content:"kmNTJS,"}/*!sc*/
.ktKOFE ul{padding-left:1.75rem;line-height:2rem;list-style-type:none;}/*!sc*/
.ktKOFE ul li:before{content:'»';margin-right:0.5rem;--tw-text-opacity:1;color:rgba(156,163,175,var(--tw-text-opacity));}/*!sc*/
.ktKOFE ol{padding-left:1.75rem;line-height:2rem;}/*!sc*/
.ktKOFE p{font-size:1.125rem;line-height:1.75rem;}/*!sc*/
.ktKOFE code{font-size:0.875rem;line-height:1.25rem;}/*!sc*/
.ktKOFE table{table-layout:auto;padding:1.25rem;border-radius:0.75rem;margin:auto;border-width:1px;--tw-border-opacity:1;border-color:rgba(156,163,175,var(--tw-border-opacity));border-style:solid;}/*!sc*/
.ktKOFE th{padding-bottom:1rem;border-width:0px;border-bottom-width:1px;--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity));border-style:solid;}/*!sc*/
.ktKOFE td{padding:0.75rem;--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity));font-size:0.875rem;line-height:1.25rem;}/*!sc*/
.ktKOFE blockquote{margin-left:1rem;margin-right:1rem;padding-left:0.5rem;border-width:0px;border-left-width:4px;border-style:solid;--tw-border-opacity:1;border-color:rgba(156,163,175,var(--tw-border-opacity));}/*!sc*/
.ktKOFE .gatsby-resp-image-figcaption{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-top:0.5rem;font-size:0.875rem;line-height:1.25rem;--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity));}/*!sc*/
.ktKOFE h1{font-size:3rem;line-height:1;}/*!sc*/
.ktKOFE h1:before{content:'#';--tw-text-opacity:1;color:rgba(209,213,219,var(--tw-text-opacity));margin-left:-1.6rem;}/*!sc*/
.ktKOFE h2{font-size:2.25rem;line-height:2.5rem;}/*!sc*/
.ktKOFE h2:before{content:'##';--tw-text-opacity:1;color:rgba(209,213,219,var(--tw-text-opacity));margin-left:-2.4rem;}/*!sc*/
.ktKOFE h3{font-size:1.875rem;line-height:2.25rem;}/*!sc*/
.ktKOFE h3:before{content:'###';--tw-text-opacity:1;color:rgba(209,213,219,var(--tw-text-opacity));margin-left:-3rem;}/*!sc*/
.ktKOFE h4{font-size:1.5rem;line-height:2rem;}/*!sc*/
.ktKOFE h4:before{content:'####';--tw-text-opacity:1;color:rgba(209,213,219,var(--tw-text-opacity));margin-left:-3.1rem;}/*!sc*/
.ktKOFE h5{font-size:1.25rem;line-height:1.75rem;}/*!sc*/
.ktKOFE h5:before{content:'#####';--tw-text-opacity:1;color:rgba(209,213,219,var(--tw-text-opacity));margin-left:-3.3rem;}/*!sc*/
.ktKOFE h6{font-size:1.125rem;line-height:1.75rem;}/*!sc*/
.ktKOFE h6:before{content:'######';--tw-text-opacity:1;color:rgba(209,213,219,var(--tw-text-opacity));margin-left:-3.5rem;}/*!sc*/
data-styled.g12[id="blog-post__Section-sc-bktxku-4"]{content:"ktKOFE,"}/*!sc*/
</style><title data-react-helmet="true">b:Log | CI/CD를 이용한 무중단 배포는 어떻게 해야 할까요? feat.Nextjs</title><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link as="script" rel="preload" href="/b-log/webpack-runtime-76465a399045a41f636f.js"/><link as="script" rel="preload" href="/b-log/framework-2c67c8bfa55bfd760b60.js"/><link as="script" rel="preload" href="/b-log/app-423680434a9201db7ee2.js"/><link as="script" rel="preload" href="/b-log/8c818aafd19f020a43cdd28cb6a1c8df7d18c0d2-0fdccc7611a7c55272d7.js"/><link as="script" rel="preload" href="/b-log/component---src-templates-blog-post-js-549bf8357642c940d19b.js"/><link as="fetch" rel="preload" href="/b-log/page-data/CICD를 이용한 무중단 배포는 어떻게 해야 할까요/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/b-log/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="BlogHeader__HeaderContainer-sc-svto0z-0 evzjD"><a class="StyledLink-sc-3uouk6-0 jQTdsB" href="/b-log/"><h1 class="BlogTitle__StyledH1-sc-15e6xzu-0 kyIceB">b:LOG</h1></a></div><div class="blog-post__Container-sc-bktxku-0 AYgxb"><header class="blog-post__Header-sc-bktxku-2 dgABOP"><h1 class="blog-post__PostTitle-sc-bktxku-3 kmNTJS">CI/CD를 이용한 무중단 배포는 어떻게 해야 할까요? feat.Nextjs</h1><span class="gaps__GapHorizontality-sc-1ekq037-0 gOnOul"><span>June 05, 2022</span></span><span class="gaps__GapHorizontality-sc-1ekq037-0 gOnOul"><a class="StyledLink-sc-3uouk6-0 Tag__TagStyledLink-sc-1hcx1ww-0 jQTdsB rWuXm" href="/b-log/tags/aws">#<!-- -->aws</a></span><span class="gaps__GapHorizontality-sc-1ekq037-0 gOnOul"><a class="StyledLink-sc-3uouk6-0 Tag__TagStyledLink-sc-1hcx1ww-0 jQTdsB rWuXm" href="/b-log/tags/guide">#<!-- -->guide</a></span></header><div class="blog-post__SectionContainer-sc-bktxku-1 bWWXUD"><div class="Toc__Container-sc-9zrjd9-0 nvvNn"><div class="Toc__Contents-sc-9zrjd9-1 dmEqLl"><ul>
<li>
<p><a href="#intro">Intro</a></p>
</li>
<li>
<p><a href="#%EC%9D%B4%EB%A0%87%EA%B2%8C-%EB%8F%8C%EC%95%84%EA%B0%91%EB%8B%88%EB%8B%A4">이렇게 돌아갑니다</a></p>
</li>
<li>
<p><a href="#%EC%A4%80%EB%B9%84%EB%AC%BC">준비물</a></p>
</li>
<li>
<p><a href="#docker">Docker</a></p>
<ul>
<li>
<p><a href="#%EC%84%A4%EC%B9%98">설치</a></p>
</li>
<li>
<p><a href="#dockerfile">Dockerfile</a></p>
<ul>
<li><a href="#enable-standalone-option">enable standalone option</a></li>
</ul>
</li>
<li>
<p><a href="#docker-compose">docker-compose</a></p>
<ul>
<li><a href="#%EC%84%A4%EC%B9%98-1">설치</a></li>
<li><a href="#%EC%84%A4%EB%AA%85">설명</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="#github-actions">Github Actions</a></p>
<ul>
<li><a href="#environments">Environments</a></li>
<li><a href="#%EC%84%A4%EB%AA%85-1">설명</a></li>
</ul>
</li>
<li>
<p><a href="#shell-scripts">Shell Scripts</a></p>
<ul>
<li><a href="#build_dockersh">build_docker.sh</a></li>
<li><a href="#switch_dockersh">switch_docker.sh</a></li>
</ul>
</li>
<li>
<p><a href="#aws">AWS</a></p>
<ul>
<li>
<p><a href="#ec2-%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4-%ED%83%9C%EA%B7%B8-%EC%84%A4%EC%A0%95">EC2 인스턴스 태그 설정</a></p>
</li>
<li>
<p><a href="#ec2%EC%97%90-codedeploy-agent-%EC%84%A4%EC%B9%98">EC2에 CodeDeploy agent 설치</a></p>
</li>
<li>
<p><a href="#%EC%97%AD%ED%95%A0-%EC%82%AC%EC%9A%A9%EC%9E%90-%EC%84%A4%EC%A0%95">역할, 사용자 설정</a></p>
<ul>
<li><a href="#ec2">EC2</a></li>
<li><a href="#codedeploy">CodeDeploy</a></li>
<li><a href="#aws-cli">AWS CLI</a></li>
</ul>
</li>
<li>
<p><a href="#codedeploy-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%B0%8F-%EB%B0%B0%ED%8F%AC-%EA%B7%B8%EB%A3%B9-%EC%83%9D%EC%84%B1">CodeDeploy 애플리케이션 및 배포 그룹 생성</a></p>
<ul>
<li><a href="#%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98">애플리케이션</a></li>
<li><a href="#%EB%B0%B0%ED%8F%AC-%EA%B7%B8%EB%A3%B9">배포 그룹</a></li>
</ul>
</li>
<li>
<p><a href="#ec2-%EC%97%AD%ED%95%A0-%EC%97%B0%EA%B2%B0">EC2 역할 연결</a></p>
</li>
<li>
<p><a href="#appspecyml">appspec.yml</a></p>
</li>
</ul>
</li>
<li>
<p><a href="#nginx">Nginx</a></p>
<ul>
<li><a href="#%EC%84%A4%EC%B9%98-2">설치</a></li>
<li><a href="#%EC%84%A4%EB%AA%85-2">설명</a></li>
</ul>
</li>
<li>
<p><a href="#%EB%A7%88%EB%AC%B4%EB%A6%AC">마무리</a></p>
</li>
</ul></div></div><section class="blog-post__Section-sc-bktxku-4 ktKOFE"><h1 id="intro" style="position:relative;"><a href="#intro" aria-label="intro permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Intro</h1>
<p>이번 글에서는 CI/CD를 통한 무중단 배포를 구현하기 위해 구른 장대한 삽질의 연대기가 소개될 예정입니다.</p>
<p>무중단 배포와 CI/CD, 듣기만 해도 든든해지는 두 단어가 퓨-젼 해버린다면 어떻게 될까요? 보기만 해도 흐뭇해져버릴 겁니다.</p>
<p>그렇습니다. 지금 실실 웃으면서 키보드를 치고 있는 이유도 그겁니다. 배포 성공, 얼마나 행복한 단어인가요?</p>
<h1 id="이렇게-돌아갑니다" style="position:relative;"><a href="#%EC%9D%B4%EB%A0%87%EA%B2%8C-%EB%8F%8C%EC%95%84%EA%B0%91%EB%8B%88%EB%8B%A4" aria-label="이렇게 돌아갑니다 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>이렇게 돌아갑니다</h1>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 521px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/b-log/static/5a2608fdb44692a5da148f5d290efadc/bb9c5/2022-06-05-01.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 65.54054054054055%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAADL0lEQVQ4y22Sz2/bZBjHH9ZKm3boadzggBAnkFA68QfsxqmHSvwLSIhdeiAaLT9OMAmGqiIxhlghtZqq7UpbhCiIIaqtidPaWWs7ies0sRMnNpnj/GjsBGdO3vdBdrNuhz3SV+/j53308fN9bIBRIOLzeqnX610I8snJSdje3r4QiUQuT09PTwQ1lmWvcxwnAcDY3NzcW8ViEVVV/VxRFIAXAfv9PpimGeaRSOS87jjO+QsR8Uo+nw+ft7a23llcXJzIZDLPgKVS6WnzJVEU7wmCsCfL8rWpqanXWZb9LZ1O/5lMJu8yDPOqKIq3JUn6fmlp6U2O4xZSqdR9nud/FwTh6ouAF3mev5VIJGKqql6dmZl5WZblm5qmfSVJ0o3l5eUre3t7Xx4cHHwdj8dfkyTpg1wud0uSpC9EUXwDAt9ra2sh1LKscUmSxnRdD+tPrR4eHkJgL5VKwWiHwPM8zM7Owv7+/tsbGxvv7e7uvivL8gQcHx/D6uoqzM/Pg2EY0Gw2od1uQ6fTAdu2w711HBeQPAlhrlGExPYK/LURB+vxY9B1ncnn81gqlVqmab4C6XQaNjc3YWFhYaxSqbzfaDQ+tm07+rzq9Xq022lHkfaj7Uohyv29E2V370d1vfJRrVa7XSgU7mmatmxZ1mfBNOPBV1tfX7/U6XQaw+EQfd/HwWCAQR6cSAiWrSb+IZt4958j/DT2K/7wyw52XRcdx0FBELBWq6HneRha7PV6oR3P807wLJ5QSn1CiD8kxEc69NePdP9OquT/9DDrrxxV/flU1dftU79p14e5XI7ouj70PG8A1Wr1Q8Mw7iiKcs00TdkwDHRdl3S7Xdpqteip49DeaYvGeY2mqy2qnijUshv0m0SJZip1ioihgiCEUCiXy0lVVVEUxU90Xc8UCgVsNpvEsizUNA3Nf2tYNyrIsAquPCrj1gMOdx4pePOBilnDDu0Eq6GUhoJsNhvYHQ9+G8/ziiPLJLgkoRBx0EeG15DVW5gWM6iaFn7HGZg1GmdAQp4BGYaBRqMBsVjsouu6akgLZh81EHLmis1X8NuHJ/jjvhbq56SCTvc/HPWfA/8HQGsGnbRUyWkAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2022 06 05 01"
        title="2022 06 05 01"
        src="/b-log/static/5a2608fdb44692a5da148f5d290efadc/bb9c5/2022-06-05-01.png"
        srcset="/b-log/static/5a2608fdb44692a5da148f5d290efadc/12f09/2022-06-05-01.png 148w,
/b-log/static/5a2608fdb44692a5da148f5d290efadc/e4a3f/2022-06-05-01.png 295w,
/b-log/static/5a2608fdb44692a5da148f5d290efadc/bb9c5/2022-06-05-01.png 521w"
        sizes="(max-width: 521px) 100vw, 521px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h1 id="준비물" style="position:relative;"><a href="#%EC%A4%80%EB%B9%84%EB%AC%BC" aria-label="준비물 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>준비물</h1>
<ul>
<li><strong>Github Actions</strong>
<ul>
<li>Github 저장소의 특정 브랜치로 푸시가 발생했을 때 여러 작업을 실행시킬 수 있습니다</li>
</ul>
</li>
<li><strong>Docker</strong></li>
<li><strong>Nginx</strong>
<ul>
<li>리버스 프록시와 로드 밸런싱을 담당합니다</li>
</ul>
</li>
<li><strong>AWS</strong>
<ul>
<li>EC2</li>
<li>S3
<ul>
<li>Code Deploy를 통해 코드를 배포하기 전 잠시 저장합니다</li>
</ul>
</li>
<li>Code Deploy
<ul>
<li>EC2로의 배포를 담당합니다</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="docker" style="position:relative;"><a href="#docker" aria-label="docker permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Docker</h1>
<h2 id="설치" style="position:relative;"><a href="#%EC%84%A4%EC%B9%98" aria-label="설치 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>설치</h2>
<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell"><span class="token function">sudo</span> amazon-linux-extras <span class="token function">install</span> <span class="token function">docker</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<h2 id="dockerfile" style="position:relative;"><a href="#dockerfile" aria-label="dockerfile permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dockerfile</h2>
<p>Nextjs를 도커 이미지로 빌드하기 위해선 그에 맞는 Dockerfile이 필요합니다.</p>
<div class="gatsby-highlight" data-language="dockerfile"><pre style="counter-reset: linenumber NaN" class="language-dockerfile line-numbers"><code class="language-dockerfile"><span class="token comment"># node_modules를 생성</span>
<span class="token instruction"><span class="token keyword">FROM</span> node:16-alpine <span class="token keyword">AS</span> deps</span>
<span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache libc6-compat</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">COPY</span> package.json yarn.lock ./</span>
<span class="token instruction"><span class="token keyword">RUN</span> yarn install --frozen-lockfile</span>

<span class="token comment"># 생성된 node_modules를 받아 빌드</span>
<span class="token instruction"><span class="token keyword">FROM</span> node:16-alpine <span class="token keyword">AS</span> builder</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">deps</span></span> /app/node_modules ./node_modules</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>

<span class="token instruction"><span class="token keyword">RUN</span> yarn build</span>

<span class="token comment"># 빌드된 파일들을 받아 실행</span>
<span class="token instruction"><span class="token keyword">FROM</span> node:16-alpine <span class="token keyword">AS</span> runner</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>

<span class="token instruction"><span class="token keyword">ENV</span> NODE_ENV production</span>

<span class="token instruction"><span class="token keyword">RUN</span> addgroup --system --gid 1001 nodejs</span>
<span class="token instruction"><span class="token keyword">RUN</span> adduser --system --uid 1001 nextjs</span>

<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /app/public ./public</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /app/package.json ./package.json</span>

<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span> <span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">nextjs:nodejs</span></span> /app/.next/standalone ./</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span> <span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">nextjs:nodejs</span></span> /app/.next/static ./.next/static</span>

<span class="token instruction"><span class="token keyword">USER</span> nextjs</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> 3000</span>

<span class="token instruction"><span class="token keyword">ENV</span> PORT 3000</span>

<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"node"</span>, <span class="token string">"server.js"</span>]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>단계를 나눠 nextjs를 빌드한 뒤 실행합니다. 사용할 파일들만 남겨 이미지 크기가 줄어드는 효과가 있습니다.</p>
<h3 id="enable-standalone-option" style="position:relative;"><a href="#enable-standalone-option" aria-label="enable standalone option permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>enable standalone option</h3>
<p>약간의 문제가 있습니다. Dockerfile에서 /.next/standalone이 보이나요? Nextjs는 기본적으로 /.next/standalone을 생성하지 않습니다. 이 디렉토리가 존재하지 않는다면 node 단독으로 실행할 수 없습니다. 설정으로 standalone을 생성하라고 Nextjs에게 알려줘야 합니다.</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset: linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> nextConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token literal-property property">experimental</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">outputStandalone</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>다음 설정을 next.config.js에 적용하면 빌드 시 standalone이 생성됩니다.</p>
<h2 id="docker-compose" style="position:relative;"><a href="#docker-compose" aria-label="docker compose permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>docker-compose</h2>
<h3 id="설치-1" style="position:relative;"><a href="#%EC%84%A4%EC%B9%98-1" aria-label="설치 1 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>설치</h3>
<blockquote>
<p>🔭 <strong>Reference</strong> <a href="https://docs.docker.com/compose/install/compose-plugin/#installing-compose-on-linux-systems">https://docs.docker.com/compose/install/compose-plugin/#installing-compose-on-linux-systems</a></p>
</blockquote>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">curl -SL https://github.com/docker/compose/releases/download/v2.5.0/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<h3 id="설명" style="position:relative;"><a href="#%EC%84%A4%EB%AA%85" aria-label="설명 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>설명</h3>
<p>이 글에서는 블루-그린 방식을 통해 무중단 배포를 구현하려고 합니다. 이 때 필요한 게 docker-compose 입니다.</p>
<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token comment"># docker-compose-blue.yml</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">blue</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>image
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 3000<span class="token punctuation">:</span><span class="token number">3000</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token comment">#docker-compose-green.yml</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">green</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>image
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 3001<span class="token punctuation">:</span><span class="token number">3000</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>블루, 그린의 역할을 하는 두 개의 docker-compose.yml이 필요합니다. 두 파일의 차이는 포트입니다. 각각 3000, 3001으로 설정했습니다.</p>
<h1 id="github-actions" style="position:relative;"><a href="#github-actions" aria-label="github actions permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Github Actions</h1>
<h2 id="environments" style="position:relative;"><a href="#environments" aria-label="environments permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Environments</h2>
<p>Github Actions 워크플로우에 쓰이는 시크릿을 정의해줘야 합니다.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/b-log/static/fb0391621f52db355a10c8fef88346ac/081ff/2022-06-07-08-28-03.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 38.513513513513516%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFUlEQVQoz32RbUsDMRCE7///PEGkaD+oaNtr7y6XpE022eSRy1WsSF0YJi+TyQ7bTbNl1xtetj0PjweGOZNVkVyISblEuUG64US48iXmpo2S6UKILJVTJQQopTIMI4f+yGQM96tSa2WyhbfPmc12xPmwGIZ2cSsyxnA6nZqxtQ7nHLO1OO/X9TnhY2lakcL7Tnj9iEhSut1uzzQZVBcB1FrwURl9JkgmpdQgjde9ZCVpoVwbWamiqnTDOGGdb1Hr6sg5JGYn5Fz+SbyaSU6EHJvZ8mFn7UytetWsougv+NGQRajX83tIugxE0FJaym7fO4JAVn6Z/jRS/8XNjFp1T5tn+qNhfyz4c6IUbZd/HtxN/q1b+QvXnXLtyeIxhwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2022 06 07 08 28 03"
        title="2022 06 07 08 28 03"
        src="/b-log/static/fb0391621f52db355a10c8fef88346ac/fcda8/2022-06-07-08-28-03.png"
        srcset="/b-log/static/fb0391621f52db355a10c8fef88346ac/12f09/2022-06-07-08-28-03.png 148w,
/b-log/static/fb0391621f52db355a10c8fef88346ac/e4a3f/2022-06-07-08-28-03.png 295w,
/b-log/static/fb0391621f52db355a10c8fef88346ac/fcda8/2022-06-07-08-28-03.png 590w,
/b-log/static/fb0391621f52db355a10c8fef88346ac/efc66/2022-06-07-08-28-03.png 885w,
/b-log/static/fb0391621f52db355a10c8fef88346ac/c83ae/2022-06-07-08-28-03.png 1180w,
/b-log/static/fb0391621f52db355a10c8fef88346ac/081ff/2022-06-07-08-28-03.png 2182w"
        sizes="(max-width: 590px) 100vw, 590px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>파란색으로 표시된 순서대로 Environments에 접근해 새로운 environment를 만들고 시크릿을 정의해주세요.</p>
<h2 id="설명-1" style="position:relative;"><a href="#%EC%84%A4%EB%AA%85-1" aria-label="설명 1 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>설명</h2>
<p>.github/workflows에 yml을 생성하여 Github Actions의 workflow를 만들어 줄 수 있습니다.</p>
<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token comment"># Workflow의 이름</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> Tests

<span class="token comment"># main 브랜치에 푸시가 일어났을 때 이 Workflow를 실행</span>
<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span>

<span class="token comment"># 실행될 작업들</span>
<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest

    <span class="token comment"># 특정 Enviroments의 시크릿을 가져옴</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy secrets

    <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
      <span class="token comment"># 생성할 작업의 노드 버전 명시</span>
      <span class="token key atrule">matrix</span><span class="token punctuation">:</span>
        <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>16.x<span class="token punctuation">]</span>

    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token comment"># Repository의 파일들을 가져옴</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v3

      <span class="token comment"># 여러 노드 환경을 동시에 만들어 냄</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Node.js $<span class="token punctuation">{</span><span class="token punctuation">{</span> matrix.node<span class="token punctuation">-</span>version <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v3
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> matrix.node<span class="token punctuation">-</span>version <span class="token punctuation">}</span><span class="token punctuation">}</span>

      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> yarn install
      <span class="token comment"># 테스트</span>
      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> yarn ci

      <span class="token comment"># 생성한 사용자를 이용해 aws에 접근</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Configure AWS credentials
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> aws<span class="token punctuation">-</span>actions/configure<span class="token punctuation">-</span>aws<span class="token punctuation">-</span>credentials@v1
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">aws-access-key-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.AWS_ACCESS_KEY_ID <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">aws-secret-access-key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.AWS_SECRET_ACCESS_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">aws-region</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.AWS_REGION <span class="token punctuation">}</span><span class="token punctuation">}</span>

      <span class="token comment"># S3에 업로드하기 위해 파일을 zip으로 압축</span>
      <span class="token comment"># -x node_modules/\* : node_modules 제외</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Compress the files
        <span class="token key atrule">run</span><span class="token punctuation">:</span> zip <span class="token punctuation">-</span>qq <span class="token punctuation">-</span>r ./$GITHUB_SHA.zip . <span class="token punctuation">-</span>x node_modules/\*

      <span class="token comment"># S3에 생성된 zip을 업로드</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload to S3
        <span class="token key atrule">run</span><span class="token punctuation">:</span> aws s3 cp <span class="token punctuation">-</span><span class="token punctuation">-</span>region $AWS_REGION ./$GITHUB_SHA.zip s3<span class="token punctuation">:</span>//only<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>test<span class="token punctuation">-</span>bucket/$GITHUB_REPOSITORY/$GITHUB_SHA.zip

      <span class="token comment"># 업로드 한 zip을 토대로 CodeDeploy에서 새로운 배포를 만들게 함</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Create new Deployment
        <span class="token key atrule">run</span><span class="token punctuation">:</span> aws deploy create<span class="token punctuation">-</span>deployment <span class="token punctuation">-</span><span class="token punctuation">-</span>application<span class="token punctuation">-</span>name $DEPLOYMENT_APP_NAME <span class="token punctuation">-</span><span class="token punctuation">-</span>deployment<span class="token punctuation">-</span>config<span class="token punctuation">-</span>name CodeDeployDefault.AllAtOnce <span class="token punctuation">-</span><span class="token punctuation">-</span>deployment<span class="token punctuation">-</span>group<span class="token punctuation">-</span>name $DEPLOY_GROUP_NAME <span class="token punctuation">-</span><span class="token punctuation">-</span>s3<span class="token punctuation">-</span>location bucket=$S3_BUCKET_NAME<span class="token punctuation">,</span>bundleType=zip<span class="token punctuation">,</span>key=$GITHUB_REPOSITORY/$GITHUB_SHA.zip</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/b-log/static/2a301034e56e99ea91c7efcc56cfbe76/31198/2022-06-05-21-06-10.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 33.108108108108105%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABbklEQVQoz42QO2/TYBSGLVokqqqq2GBAjKgdOvbvsEDVIhhAFQMCsfT3NKpKu4AYuzU0CYHaSRznaseJ4zSf7diO/T1VnFRZisQrPdLROUfvuSiqVqFYKnOtatj9PjNJKTNmmoQR5bbPn46PZgYUGj7Fps/Im2T10u8yJ6dnfP/xE9OyUJrNFnrdoG40cIZD7nRnGEYxjX6AYQc0BwF6L6DW8xFBmNWF8LJltEqNoeuipBJS5kRxwiSMiacJSSozprMGFshlnKTzgVbPxrRs2l2Tm7FA8UZ9HLuL0+tgtQ2sToM08vg/ycU1y4xyfCn4VhDk8mNyecHp1Zizgvgn50XByS/BRTXIDDw/wBm6DByXVsdEefqhyuN3FV580tn+ovNoX+PBq2tWX6us3MPDPRXl5V92vtaZxJI4inDcEZ7vZ6bKk/dVnh1Wef6xxtZnnc23Gmv7KusH2r1svJkP3D0yCOP5X6dJSpKkpFJyC7RK5qrr1UrBAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2022 06 05 21 06 10"
        title="2022 06 05 21 06 10"
        src="/b-log/static/2a301034e56e99ea91c7efcc56cfbe76/fcda8/2022-06-05-21-06-10.png"
        srcset="/b-log/static/2a301034e56e99ea91c7efcc56cfbe76/12f09/2022-06-05-21-06-10.png 148w,
/b-log/static/2a301034e56e99ea91c7efcc56cfbe76/e4a3f/2022-06-05-21-06-10.png 295w,
/b-log/static/2a301034e56e99ea91c7efcc56cfbe76/fcda8/2022-06-05-21-06-10.png 590w,
/b-log/static/2a301034e56e99ea91c7efcc56cfbe76/31198/2022-06-05-21-06-10.png 694w"
        sizes="(max-width: 590px) 100vw, 590px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>푸시한 Repository로 가서 Actions를 확인해 보면 Tests라는 workflow가 생성된 걸 볼 수 있습니다.</p>
<p>이제 Github Actions는 main 브랜치에 푸시가 들어오면 workflow에 적어준 작업들을 차례대로 실행하고 결과에 따라 성공, 실패를 알려줍니다.</p>
<h1 id="shell-scripts" style="position:relative;"><a href="#shell-scripts" aria-label="shell scripts permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Shell Scripts</h1>
<p>CodeDeploy를 통해 실행될 쉘 스크립트를 만들어 보겠습니다.</p>
<h2 id="build_dockersh" style="position:relative;"><a href="#build_dockersh" aria-label="build_dockersh permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>build_docker.sh</h2>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span>

<span class="token comment"># 작업할 디렉토리</span>
<span class="token assign-left variable">WORKDIR</span><span class="token operator">=</span>/home/ec2-user/temp

<span class="token builtin class-name">cd</span> <span class="token variable">$WORKDIR</span>
<span class="token function">docker</span> build -t docker-tag <span class="token builtin class-name">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>첫번째로 실행될 스크립트입니다. 가져온 파일들을 이용해 새로운 도커 이미지를 빌드합니다.</p>
<h2 id="switch_dockersh" style="position:relative;"><a href="#switch_dockersh" aria-label="switch_dockersh permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>switch_docker.sh</h2>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span>

<span class="token comment"># 실행 중인 도커 컨테이너를 특정할 수 있는 문자열</span>
<span class="token assign-left variable">KEYWORD</span><span class="token operator">=</span>running
<span class="token comment"># 작업할 디렉토리</span>
<span class="token assign-left variable">WORKDIR</span><span class="token operator">=</span>/home/ec2-user/temp
<span class="token builtin class-name">cd</span> <span class="token variable">$WORKDIR</span>

<span class="token comment"># docker-compose-blue.yml을 통해 실행된 컨테이너들의 목록</span>
<span class="token assign-left variable">IS_BLUE_RUNNING</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">docker-compose</span> -p blue -f docker-compose-blue.yml <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> $KEYWORD<span class="token variable">)</span></span>
<span class="token assign-left variable">IS_GREEN_RUNNING</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">docker-compose</span> -p green -f docker-compose-green.yml <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> $KEYWORD<span class="token variable">)</span></span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> -z <span class="token string">"<span class="token variable">$IS_BLUE_RUNNING</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token function">docker-compose</span> -p blue -f docker-compose-blue.yml up -d 
  <span class="token keyword">if</span> <span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$IS_GREEN_RUNNING</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token comment"># 슬립을 통해 블루가 완벽히 실행될 때까지의 유예를 줌</span>
    <span class="token function">sleep</span> <span class="token number">10</span>
    <span class="token function">docker-compose</span> -p green -f docker-compose-green.yml down
  <span class="token keyword">fi</span>
<span class="token keyword">else</span>
  <span class="token function">docker-compose</span> -p green -f docker-compose-green.yml up -d 

  <span class="token comment"># 슬립을 통해 그린이 완벽히 실행될 때까지의 유예를 줌</span>
  <span class="token function">sleep</span> <span class="token number">10</span>
  <span class="token function">docker-compose</span> -p blue -f docker-compose-blue.yml down
<span class="token keyword">fi</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>두번째로 실행될 스크립트입니다. 빌드된 도커 이미지를 docker-compose를 통해 실행합니다.</p>
<p>현재 그린이 실행되고 있다고 가정합시다. 스크립트는 블루를 새로 실행하고 일정 시간 후 그린을 종료합니다. 이를 통해 서비스를 끊김없이 유지할 수 있습니다.</p>
<h1 id="aws" style="position:relative;"><a href="#aws" aria-label="aws permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>AWS</h1>
<h2 id="ec2-인스턴스-태그-설정" style="position:relative;"><a href="#ec2-%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4-%ED%83%9C%EA%B7%B8-%EC%84%A4%EC%A0%95" aria-label="ec2 인스턴스 태그 설정 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EC2 인스턴스 태그 설정</h2>
<p>CodeDeploy에서 인스턴스를 구별하기 위해 태그를 사용합니다. 태그 관리로 들어가 새로운 태그를 생성해주세요. 키와 값은 마음대로 생성해도 됩니다.</p>
<h2 id="ec2에-codedeploy-agent-설치" style="position:relative;"><a href="#ec2%EC%97%90-codedeploy-agent-%EC%84%A4%EC%B9%98" aria-label="ec2에 codedeploy agent 설치 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EC2에 CodeDeploy agent 설치</h2>
<blockquote>
<p>🔭 <strong>Reference</strong> <a href="https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/codedeploy-agent-operations-install-linux.html">https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/codedeploy-agent-operations-install-linux.html</a></p>
</blockquote>
<p>CodeDeploy가 EC2 Instance에 파일들을 배포하고 스크립트를 실행하기 위해서는 CodeDeploy agent가 있어야 합니다.</p>
<p>에이전트를 설치하는 방법은 두가지가 있습니다. 하나는 AWS Systems Manager를, 다른 하나는 명령줄을 이용합니다. 이번에는 명령줄로 설치해보겠습니다.</p>
<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell"><span class="token function">sudo</span> yum update

<span class="token function">sudo</span> yum <span class="token function">install</span> ruby

<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token function">wget</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>먼저 필요한 패지키들을 받아야 합니다. yum을 업데이트 후 패키지들을 설치해주세요.</p>
<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell">https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/resource-kit.html<span class="token comment">#resource-kit-bucket-names</span>

<span class="token function">wget</span> https://bucket-name.s3.region-identifier.amazonaws.com/latest/install

<span class="token function">wget</span> https://aws-codedeploy-ap-northeast-2.s3.ap-northeast-2.amazonaws.com/latest/install</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>그 다음 CodeDeploy agent의 설치 파일을 다운받습니다. 이 파일은 아마존의 리소스 키트 S3 버킷에 위치하고 있습니다. 리전별로 주소가 달라지니 상단의 예시 주소를 참고해 EC2 인스턴스가 해당하는 리전을 찾아 bucket-name과 region-identifier를 알맞게 변경해주세요.</p>
<p>저는 토종 한국인이기 때문에 서울 리전으로 인스턴스를 생성했습니다. bucket-name은 aws-codedeploy-ap-northeast-2, region-identifier는 ap-northeast-2가 되겠네요.</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">chmod +x ./install

sudo ./install auto</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>다운받은 설치 파일을 실행할 수 있도록 권한을 주고 CodeDeploy agent를 설치합니다.</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">sudo service codedeploy-agent status</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>이제 CodeDeploy agent가 제대로 실행되고 있는지 확인해보세요. 실행되고 있지 않다면 직접 실행시켜줘야 합니다.</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">sudo service codedeploy-agent start</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<p>실행 후 status를 사용해 다시 한 번 확인해 보세요.</p>
<h2 id="역할-사용자-설정" style="position:relative;"><a href="#%EC%97%AD%ED%95%A0-%EC%82%AC%EC%9A%A9%EC%9E%90-%EC%84%A4%EC%A0%95" aria-label="역할 사용자 설정 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>역할, 사용자 설정</h2>
<p>AWS는 IAM을 통해 액세스를 관리합니다. 그 중에서 역할과 사용자를 설정해 줄 겁니다. 역할은 CodeDeploy와 EC2, 사용자는 AWS CLI에 사용됩니다.</p>
<h3 id="ec2" style="position:relative;"><a href="#ec2" aria-label="ec2 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EC2</h3>
<p>EC2는 CodeDeploy를 통해 S3에서 zip 파일을 가져와야 합니다. CodeDeploy와 S3의 권한이 필요하겠네요.</p>
<ol>
<li>IAM의 역할로 들어가 역할 만들기로 새로운 역할을 만들어 줍니다.</li>
</ol>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/b-log/static/804f75574039778159581af6c5461638/80260/2022-06-05-23-45-35.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 30.405405405405407%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmklEQVQY05VRAQrCMAzc///nE8RhRdaONm2a9CRVEbY6MXA0hNxxl05X53CZZyzeQ0TRGtBa20FVO979aMcw3dYM5xMWEtwjw2cFUQZRAjOjlIJaK3LOHdbb3F4T2NYUY0QiQulkW5ROIKJOMogIRjV06H1AZQa/nPwiHEHVBEPAGkKPZk7+FdlFtnh2m6NDf/ukZ/9JcjpHPACZedmBubvM8gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2022 06 05 23 45 35"
        title="2022 06 05 23 45 35"
        src="/b-log/static/804f75574039778159581af6c5461638/fcda8/2022-06-05-23-45-35.png"
        srcset="/b-log/static/804f75574039778159581af6c5461638/12f09/2022-06-05-23-45-35.png 148w,
/b-log/static/804f75574039778159581af6c5461638/e4a3f/2022-06-05-23-45-35.png 295w,
/b-log/static/804f75574039778159581af6c5461638/fcda8/2022-06-05-23-45-35.png 590w,
/b-log/static/804f75574039778159581af6c5461638/efc66/2022-06-05-23-45-35.png 885w,
/b-log/static/804f75574039778159581af6c5461638/c83ae/2022-06-05-23-45-35.png 1180w,
/b-log/static/804f75574039778159581af6c5461638/80260/2022-06-05-23-45-35.png 4312w"
        sizes="(max-width: 590px) 100vw, 590px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<ol start="2">
<li>
<p>신뢰할 수 있는 엔티티 유형은 AWS 서비스, 사용 사례는 EC2를 선택하고 다음을 누릅니다.</p>
</li>
<li>
<p>다음은 권한 추가입니다. AmazonS3FullAccess, AWSCodeDeployFullAccess를 검색해 선택하고 다음을 누릅니다.</p>
</li>
<li>
<p>마지막 화면입니다. 한 눈에 알아볼만한 역할 이름을 적고 역할을 생성해주세요. 설명을 적어도 상관 없습니다.</p>
</li>
</ol>
<h3 id="codedeploy" style="position:relative;"><a href="#codedeploy" aria-label="codedeploy permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CodeDeploy</h3>
<ol>
<li>IAM의 역할로 들어가 역할 만들기로 새로운 역할을 만들어 줍니다.</li>
</ol>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/b-log/static/315945cec09786624a482265500aae98/80260/2022-06-05-23-57-18.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 35.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAqklEQVQoz42Q4QrDIAyEff+n3L9ttM7RxRqj9kbsLKNTWOAjEcnlEnObLK73CQutYMmQAuScUYpSDlJKFa33/4Jt234wzkc8iLFwhvNS8xoCvPcQEcQYq5BmRcX0rbkXhugF5oAkUlFnTUCbmptedB0S0We6IA2m9hpHGOeeUFFdr63xT2O74Xmwma2FtRbMjBDCcbPR0c80IWCvjbpq7r7pORido+XLzHgD31koppog9pkAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2022 06 05 23 57 18"
        title="2022 06 05 23 57 18"
        src="/b-log/static/315945cec09786624a482265500aae98/fcda8/2022-06-05-23-57-18.png"
        srcset="/b-log/static/315945cec09786624a482265500aae98/12f09/2022-06-05-23-57-18.png 148w,
/b-log/static/315945cec09786624a482265500aae98/e4a3f/2022-06-05-23-57-18.png 295w,
/b-log/static/315945cec09786624a482265500aae98/fcda8/2022-06-05-23-57-18.png 590w,
/b-log/static/315945cec09786624a482265500aae98/efc66/2022-06-05-23-57-18.png 885w,
/b-log/static/315945cec09786624a482265500aae98/c83ae/2022-06-05-23-57-18.png 1180w,
/b-log/static/315945cec09786624a482265500aae98/80260/2022-06-05-23-57-18.png 4312w"
        sizes="(max-width: 590px) 100vw, 590px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<ol start="2">
<li>
<p>신뢰할 수 있는 엔티티 유형은 AWS 서비스, 사용 사례는 검색을 통해 CodeDeploy를 선택하고 다음을 누릅니다.</p>
</li>
<li>
<p>다음은 권한 추가입니다. AWSCodeDeployRole가 이미 선택되어 있을겁니다. 다음을 누릅니다.</p>
</li>
<li>
<p>마지막 화면입니다. 한 눈에 알아볼만한 역할 이름을 적고 역할을 생성해주세요. 설명을 적어도 상관 없습니다.</p>
</li>
</ol>
<h3 id="aws-cli" style="position:relative;"><a href="#aws-cli" aria-label="aws cli permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>AWS CLI</h3>
<p>AWS CLI는 액세스 키를 통해 인증을 진행합니다. 액세스 키를 얻기 위해서는 역할이 아닌 사용자를 생성해야 합니다.</p>
<p>AWS CLI를 통해 Github Actions에서 S3에 zip을 업로드하고 CodeDeploy에 새로운 배포를 생성하게 할 겁니다. S3와 CodeDeploy의 권한이 필요합니다.</p>
<ol>
<li>
<p>IAM의 사용자로 들어가 새로운 사용자를 만들어 줍니다.</p>
</li>
<li>
<p>한 눈에 알아볼만한 사용자 이름을 적고 자격 증명 유형에 액세스 키 - 프로그래밍 방식 액세스를 선택해주세요.</p>
</li>
<li>
<p>권한 설정에 기존 정책 직접 연결로 가서 AmazonS3FullAccess, AWSCodeDeployFullAccess를 찾아 선택해주세요.</p>
</li>
<li>
<p>태그는 지나쳐도 됩니다.</p>
</li>
<li>
<p>검토 후 사용자를 생성하세요.</p>
</li>
</ol>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 270px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/b-log/static/b11c98564d28522b90a9df4360c7adad/01bf6/2022-06-06-00-10-30.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 222.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAsCAYAAABloJjNAAAACXBIWXMAABYlAAAWJQFJUiTwAAAEa0lEQVRIx61X21IbRxDdT8kHJf+SlzyQB/KWVHjKQ6pSgSgOkFA2Fpg4LiHK4DJBxhGqAguE0F1CEhJC9/tedVKnxWKxSEGYjKprZnpmTp+e7l31KgAwGAxg9+NkdM25z272XJm0eZwB5+Fx64pz47ixE2hSu2HY7/fR7XZRLBZlnMlkEI1Gkc/nUa1WkUqlkE6n0Wq15CD3BgIBZLNZaJqG8/Nz5HI5XFxcDAFLpRJCoZAAcTEYDGJ/fx/hcBjtdlvGPByLxQSQ4Ds7OwJqGIYQOT4+xtHR0dBlsjk7OxMFrRwcHGB7e1vmNHJ6eioHyIItEomIUeoKhYKcJ3vqFMuyhLZtudfryQYukpG9Rvfr9frNfSWTSWGv67rsIVNejTIpINzoXLsvIBKUSeEflyL3pYykzX2JPSllJib2JIufKsp/3cunNHHZsEyopgbV1B8tSkfvIVA+RbieRKiewOkjRan0G0i2srxWaAMV+kATUa0+tOvxONGuxalXqmoTieY5jIGOrtkV6Vt9uQ/VUmXeM3u3hHobzLk2BGxlYcKQw5qloqG34Mn6UFFrN4dohH3H7Io+371EtlO8tcb+FmDb6Aizrw9+xGcrn+PbIxcsGAJCD9LtPH4+c8Od2sbr/HsZjxq9w3AIOMD3H57gC++X+OqfHwBY6BidG8Dvjn7FYvQvMfZN4CcBpFddozvB5YGGht6EJ+dDVavfsq5DR6iVQFErI9MvINXLyzl1oMKAAQ3abcDRS2ejZVvHzZe1S2QyKaQySYTCJziLhHESOUGlVZG+UC44GY5c/rULnNMdEyYiiQj+9LzEU/dTLDz5BYt/LOH5i+eIJCNw/ebCO/+78YDjRJgPVLS1toyr7So6WgeVZkV0V/UrdPTOdIA2WK1dQ7aYRTKbRDwTlz5fyiOdTwtgqV6aDpAu89Jj6Ri8214s/r4oLq6/XMfK6oqI/9CPw5PD6RnawOVmWYJzUb5ANBVFMBwU1sVqEY1e42F3yF67/jGFyJrB4pi6O0/KfQydzy3FTmgZ6937AUfBGBhbOLcjzjlZygt2KoZGT9xL5VJYXV+V3HO/cOOV95Uk9DP3M2y+3sSbv99Mx9B+7Jgee+/3JIEDHwISWQbkre+tgLk33A9zmRdvwZJAGNfPsK3jnP2Dg8Ig2DIuMHcAe48UAUyOvG0m5eG0In9SkUZa3nt8wfLt/BhR+qaGYDU2/BusPV4U/M9NShHTND+K9XHMmk/ENMbq2DvPKKwDWX2yaGSxSVFVVcQ+wD12YTkKzN4+x77RaAwBK5WK0N3a2sLm5qaMWa2y3o7H41KDs6rd29uDz+eDx+OR3uv1wu/3S+VKAldXV1CIXC6XpX6emZnB7OysFOGssRcWFjA3N4elpSUp0Dc2NjA/Pw+Xy4Xl5WUZr62tYXd3F81mU8pmAWRhzvqaRTi/BmiRzFhjs5bmnAap45cBi3jup57riUTiZl2Cwm8RulWr1WRM6mTNq2BP4bqto9h7nOv/AhFWCpTlNsGIAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2022 06 06 00 10 30"
        title="2022 06 06 00 10 30"
        src="/b-log/static/b11c98564d28522b90a9df4360c7adad/01bf6/2022-06-06-00-10-30.png"
        srcset="/b-log/static/b11c98564d28522b90a9df4360c7adad/12f09/2022-06-06-00-10-30.png 148w,
/b-log/static/b11c98564d28522b90a9df4360c7adad/01bf6/2022-06-06-00-10-30.png 270w"
        sizes="(max-width: 270px) 100vw, 270px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<ol start="6">
<li>사용자 추가가 성공했다면 반드시 csv 파일을 저장해 놓으세요. 시크릿 키는 이 화면 이후 절대 찾을 수 없습니다.</li>
</ol>
<h2 id="codedeploy-애플리케이션-및-배포-그룹-생성" style="position:relative;"><a href="#codedeploy-%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%B0%8F-%EB%B0%B0%ED%8F%AC-%EA%B7%B8%EB%A3%B9-%EC%83%9D%EC%84%B1" aria-label="codedeploy 애플리케이션 및 배포 그룹 생성 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CodeDeploy 애플리케이션 및 배포 그룹 생성</h2>
<p>이 과정을 통해 어떤 인스턴스에 배포를 수행할지, 어떻게 수행할지 정해줄 수 있습니다.</p>
<h3 id="애플리케이션" style="position:relative;"><a href="#%EC%95%A0%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98" aria-label="애플리케이션 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>애플리케이션</h3>
<ol>
<li>
<p>CodeDeploy > 애플리케이션에서 애플리케이션을 생성하세요</p>
</li>
<li>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/b-log/static/c1a502b25b7b8f1b7e8759b936a7979e/0ef7e/2022-06-06-00-21-06.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 42.567567567567565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA50lEQVQoz52R3UoDMRCF85TeCb3vE3khvfJxrHcWoaW22yrYJSSbTJbdJHNkIqwr1nZx4CPkZ87MyajH5ROeVytU1QExRnRd9y/6vkdoWygRyTkPpJSQZL2GvBshuSKs9tUBx+MbPFE5lGDmy+B8SHPKOY/GOThP6GP8VfkcxRXzj+KDIIUwVBhbv4RY5r8E15stnPfTrI6Sv/e5AOYyGLV93eFU1+VyaodEYRAeR8oMZayFbZoylKnIn1NoEUIAmRpkTgVvaijrXBEUYWObK3wVt9aiev+A3r9A399CL2bQdzfQD3N8Atp1vDmBmowRAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2022 06 06 00 21 06"
        title="2022 06 06 00 21 06"
        src="/b-log/static/c1a502b25b7b8f1b7e8759b936a7979e/fcda8/2022-06-06-00-21-06.png"
        srcset="/b-log/static/c1a502b25b7b8f1b7e8759b936a7979e/12f09/2022-06-06-00-21-06.png 148w,
/b-log/static/c1a502b25b7b8f1b7e8759b936a7979e/e4a3f/2022-06-06-00-21-06.png 295w,
/b-log/static/c1a502b25b7b8f1b7e8759b936a7979e/fcda8/2022-06-06-00-21-06.png 590w,
/b-log/static/c1a502b25b7b8f1b7e8759b936a7979e/efc66/2022-06-06-00-21-06.png 885w,
/b-log/static/c1a502b25b7b8f1b7e8759b936a7979e/c83ae/2022-06-06-00-21-06.png 1180w,
/b-log/static/c1a502b25b7b8f1b7e8759b936a7979e/0ef7e/2022-06-06-00-21-06.png 1594w"
        sizes="(max-width: 590px) 100vw, 590px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
한 눈에 알아볼만한 이름을 적고 컴퓨팅 플랫폼으로 EC2/온프레미스를 선택해주세요</p>
</li>
</ol>
<h3 id="배포-그룹" style="position:relative;"><a href="#%EB%B0%B0%ED%8F%AC-%EA%B7%B8%EB%A3%B9" aria-label="배포 그룹 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>배포 그룹</h3>
<ol>
<li>
<p>생성한 애플리케이션에 들어가 배포 그룹을 생성하세요</p>
</li>
<li>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/b-log/static/0af9c1217a90dde978e0f4fdae006d85/1e5d2/2022-06-06-00-25-07.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 45.27027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA9klEQVQoz5WR6W7DIBCEef8n7I+mluKYOj4Ac9lcngjsREkPyVnp0yywGolZcu06NJTiq6ogpYJzDvOyYHmD+7wxFoRxjrZtUdcXWGuRUkKM8S3CrtmUGGPQ9wM4F3DOHzdMCfda17Wo9x7EWIthZOUykw0PsZs8VzFUWkMbA6U0tDalP4x+Vak0SNd1+DydcD7XCCGUpRxh+aPPvyV5EUJMYFwUw1f20EPczjHC++1t/RFBjisbE8oEPmqKqu1xlRqUS1A+PbRhG99CFS6jQMMldIi/MwwBZFQGdc/QDAyjmaFDgvLxf0KE9BHT7MoS3E7u7TzjBqU9vJBK98iRAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2022 06 06 00 25 07"
        title="2022 06 06 00 25 07"
        src="/b-log/static/0af9c1217a90dde978e0f4fdae006d85/fcda8/2022-06-06-00-25-07.png"
        srcset="/b-log/static/0af9c1217a90dde978e0f4fdae006d85/12f09/2022-06-06-00-25-07.png 148w,
/b-log/static/0af9c1217a90dde978e0f4fdae006d85/e4a3f/2022-06-06-00-25-07.png 295w,
/b-log/static/0af9c1217a90dde978e0f4fdae006d85/fcda8/2022-06-06-00-25-07.png 590w,
/b-log/static/0af9c1217a90dde978e0f4fdae006d85/efc66/2022-06-06-00-25-07.png 885w,
/b-log/static/0af9c1217a90dde978e0f4fdae006d85/c83ae/2022-06-06-00-25-07.png 1180w,
/b-log/static/0af9c1217a90dde978e0f4fdae006d85/1e5d2/2022-06-06-00-25-07.png 1630w"
        sizes="(max-width: 590px) 100vw, 590px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
한 눈에 알아볼만한 이름을 적고 전에 생성한 CodeDeploy 역할을 선택해주세요</p>
</li>
<li>
<p>배포 유형은 현재 위치를 선택해주세요</p>
</li>
<li>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/b-log/static/1bf848c31860dcfd9c444d00cfa6edaa/6ee58/2022-06-06-00-27-29.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 85.8108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAAB8UlEQVQ4y41UiY7aMBTk/3+v3a3EbsuVEBJy2YlvO1O9R0gBLV0sjQxP9uQdM15V1RmbzRZd18N7D2stnHMvg85fobTGSgiJum4wDOPNgX8HjbF3l25hrEUIASFGxBg5tqILvZBoux5t26HrBXoheJfDsOxCDqCP01n6L+XA51JKmKYJE8AVrmIIMFpDSolxHCGkRN/3eHUx2TTxbyY8CY1j1aAsS5TVmQltiNAuwPoI7QOMj/CRMkmc0S2ILM2kTGhcgNIG/VyaUhq9jShHj1YHnEePanAYXZwz+jrLJUMq73DIkOdHFEWBQ5YhzzIc8/yyZxmauoYx+q7ERyyEddPgx883rNcf2O8P2B8yfP7+g91uj+1uj812B23McukZ6UKoteGxT1/UQjGtNcvhcQBPSyYtkTSUUtxcIqdmU5wyO5Ulsjxn0VI8pgQ765XMUDcta/COsO06Hgit6/SuxCRcEjztKU0X0kXIjj9MsYVwVArH4oT8WLBwY0wvae5pyZQ69ZGcQPaLcz8f9fYdFh36EDCQQ4RgtxBh+g/hVch3uCU0xoDKvjwO/jujLa64xZ1T6KV5f/+F9ccnyrLiLJvRIRcW5eAYhXTsGDW75dmialckAWIm0MtDUlHWYzAOo/UXGM8x6wO3hJ+sB1CcJv4X/6wvOJePGDMAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2022 06 06 00 27 29"
        title="2022 06 06 00 27 29"
        src="/b-log/static/1bf848c31860dcfd9c444d00cfa6edaa/fcda8/2022-06-06-00-27-29.png"
        srcset="/b-log/static/1bf848c31860dcfd9c444d00cfa6edaa/12f09/2022-06-06-00-27-29.png 148w,
/b-log/static/1bf848c31860dcfd9c444d00cfa6edaa/e4a3f/2022-06-06-00-27-29.png 295w,
/b-log/static/1bf848c31860dcfd9c444d00cfa6edaa/fcda8/2022-06-06-00-27-29.png 590w,
/b-log/static/1bf848c31860dcfd9c444d00cfa6edaa/efc66/2022-06-06-00-27-29.png 885w,
/b-log/static/1bf848c31860dcfd9c444d00cfa6edaa/c83ae/2022-06-06-00-27-29.png 1180w,
/b-log/static/1bf848c31860dcfd9c444d00cfa6edaa/6ee58/2022-06-06-00-27-29.png 1640w"
        sizes="(max-width: 590px) 100vw, 590px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
Amazon EC2 인스턴스를 선택 후 알맞은 태그를 선택해주세요</p>
</li>
<li>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/b-log/static/db12b0cf19189866a4a477cd7c57f4d4/6ee58/2022-06-06-00-30-08.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 44.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABU0lEQVQoz4VSa4+DIBDk//+4S1qLWnu59KXVVpBaRQF1LuxZr/flSjJhWYbZF0xIiaK4QkqJsiwJRVEgTTNklwvZolLQXY++79E90XXQXUf7E03bgp3PKTiPEMVbJMkOYRQTeBhhm+ywTRJ8nTJcpcL9foesKiilYIyBcw7WWrL97gMwYy3cOKE3BsZYWE9yjrLxRO/3ttYardZomhZtqxe/507ThGEcKUtmtUYdrsB5iGDDsdmEWK0DfKwCrHmEgEdL1lEU033sq9l9Igg49vsDhJAk7oOwwVm4WuF2K5HnBfUzL65I5QOHskZeNS+ZGuqfoWrmc9dT5sMwkChT9QNlpVBVFfXHw1/+rolK+heeNU0UhKWiRnYpfvphLWGRmh940fnVfF4If3x+Hkz3PY7HE5XqpyeEQFkKavKr6DssguM4ksNat3wDN0/uKfhuvQp+AyPqtJJx+CwGAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2022 06 06 00 30 08"
        title="2022 06 06 00 30 08"
        src="/b-log/static/db12b0cf19189866a4a477cd7c57f4d4/fcda8/2022-06-06-00-30-08.png"
        srcset="/b-log/static/db12b0cf19189866a4a477cd7c57f4d4/12f09/2022-06-06-00-30-08.png 148w,
/b-log/static/db12b0cf19189866a4a477cd7c57f4d4/e4a3f/2022-06-06-00-30-08.png 295w,
/b-log/static/db12b0cf19189866a4a477cd7c57f4d4/fcda8/2022-06-06-00-30-08.png 590w,
/b-log/static/db12b0cf19189866a4a477cd7c57f4d4/efc66/2022-06-06-00-30-08.png 885w,
/b-log/static/db12b0cf19189866a4a477cd7c57f4d4/c83ae/2022-06-06-00-30-08.png 1180w,
/b-log/static/db12b0cf19189866a4a477cd7c57f4d4/6ee58/2022-06-06-00-30-08.png 1640w"
        sizes="(max-width: 590px) 100vw, 590px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
CodeDeploy agent는 이미 설치했으니 안 함을 선택해주세요</p>
</li>
<li>
<p>배포 그룹을 생성합니다</p>
</li>
</ol>
<h2 id="ec2-역할-연결" style="position:relative;"><a href="#ec2-%EC%97%AD%ED%95%A0-%EC%97%B0%EA%B2%B0" aria-label="ec2 역할 연결 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>EC2 역할 연결</h2>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/b-log/static/95c6634cbe745f2f84155fd83ed28905/d0ab7/2022-06-06-00-16-14.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 30.405405405405407%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAqElEQVQY061QWw6DMAzr/W+3TfxObNqAtdCS0EJbHp5axA6AZsmxE0X+sKiqGpfrDUVR4P5qwG5CjAEhnKMgIjQfibbtUEuFThvEGE9TpGGdw7puOLBt22nmwHEc8S8IbQzKxxPa9OiJszIP2RPzz6cqiId8Sz9aGxhiKMOQmqB0D2sdxLwsmOcFPoSdfi/32A8/eY8QYtZUkVQKHVlU/YSytXgbh5T1BWJs0yAbxvIkAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="2022 06 06 00 16 14"
        title="2022 06 06 00 16 14"
        src="/b-log/static/95c6634cbe745f2f84155fd83ed28905/fcda8/2022-06-06-00-16-14.png"
        srcset="/b-log/static/95c6634cbe745f2f84155fd83ed28905/12f09/2022-06-06-00-16-14.png 148w,
/b-log/static/95c6634cbe745f2f84155fd83ed28905/e4a3f/2022-06-06-00-16-14.png 295w,
/b-log/static/95c6634cbe745f2f84155fd83ed28905/fcda8/2022-06-06-00-16-14.png 590w,
/b-log/static/95c6634cbe745f2f84155fd83ed28905/efc66/2022-06-06-00-16-14.png 885w,
/b-log/static/95c6634cbe745f2f84155fd83ed28905/c83ae/2022-06-06-00-16-14.png 1180w,
/b-log/static/95c6634cbe745f2f84155fd83ed28905/d0ab7/2022-06-06-00-16-14.png 1532w"
        sizes="(max-width: 590px) 100vw, 590px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>CodeDeploy로 배포할 인스턴스의 IAM 역할 수정에서 EC2에 해당하는 역할을 적용해주세요.</p>
<h2 id="appspecyml" style="position:relative;"><a href="#appspecyml" aria-label="appspecyml permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>appspec.yml</h2>
<div class="gatsby-highlight" data-language="yml"><pre style="counter-reset: linenumber NaN" class="language-yml line-numbers"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">0.0</span>
<span class="token key atrule">os</span><span class="token punctuation">:</span> linux
<span class="token comment"># source에서 destination(ec2 instance)로 파일들을 옮김</span>
<span class="token key atrule">files</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span> /
    <span class="token key atrule">destination</span><span class="token punctuation">:</span> /home/ec2<span class="token punctuation">-</span>user/temp

<span class="token comment"># 실행할 스크립트 정의</span>
<span class="token key atrule">hooks</span><span class="token punctuation">:</span>
  <span class="token key atrule">AfterInstall</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">location</span><span class="token punctuation">:</span> /scripts/build_docker.sh
  <span class="token key atrule">ApplicationStart</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">location</span><span class="token punctuation">:</span> /scripts/switch_docker.sh</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>appspec.yml은 배포 시 CodeDeploy가 할 행동을 정의합니다.</p>
<p><figure class="gatsby-resp-image-figure" style="">
    <span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 485px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/b-log/static/9152e8f90004c9cbcc9fd5182e206bbe/44c61/2022-06-06-11-38-50.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 164.86486486486487%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAhCAYAAADZPosTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFhElEQVRIx5WWfW/b1hnF/Z23romTtNma1vWb7DhNsKFAgWFfYH8UW7F1xbImjWPLerNEURL1RoqiRFGUSIoiJVL6DfcqcSy02FwCFyT4cnjuOc957t2Jlwni6FsmzVaTvmXR6Xbo6h2MXo80XbFer1ksE6ZTl6nn4Qe+HJ7n4fkeQRAwn8/lezvxMiVNlvTMHmbPwBpYNOoNDEPHNE3iRcwaWCQpYRigGwYVpYKm1Wk1NZSqsnkvjjaA0WLD8P1h2yPskbN1L12tmIVzVmlKFEWSpetOGLsunueziBckSSKfbQF+8+e/cPL0jOcvXvD02VfMo1jeXyYp7tRjHoYS6DBzyv5Rhs/39nn+x6+ZzUJms5kE34mEhus1qzVcFct8+90/+eu3f+f126zUTRxJmjL1fAkYzELeZvP87R//4rvvf5DfhPO5BPT9gJ14kbACuiOPcquH0rVQDZtqd0DDHLNcbwA9P2DizyioLRq9EZVWj4bpUO2YXGsGs3mE7/sbU8QHpu3S7dvUWjrXqoYxcNAHDkIS4fRUAHo+TcOiaQzIlVWuay1avQFtcyh/KNzeSddg9gccHJ+QOX0qNTw9eyY1/PLgiFKlKqcdziNyhRK7jz6V7xwcZTh79hUHR8c8/PT3NJqtjSmLZLV5uVShWFE5v8zxn5/eUlJqZAvX0ozVeo0fzDCtAT++ueAyX+L7f//Iy1dveHtV4NX5pawMoeOOKGxhSAhUOxaqPqBm2CidPtME0nemTDyPMFqgmQ7XDZ1CvYvaHVCqt+k6AfNosdFwsUxZLhN0a4Ru2VS1DkWljjEY0enbhFHMarWSLnvBDGvsMZwE1NoG7d6QoeszGPtyBtJlwU5M5cEnj7m/+5D9wyMyJ0959Mljfvu7ezcaupOpZNiyXPJqk0K9Q1nTKTZ0urZPOI/fMUxSojimrDao1DSyhTJvLnMo9SZFpYbnz6SGgqHQs97uSXbZkkKx2qDeNmh0evK5dFlomK7WBClo/TGlRpdiw6DatZgsYbkSSUlkaq7yRT77fI/jzAmHxxmOT07ltagGta5tXH4P6M2X+HEqNRL1GMQp03DJMl1JU4RGg+FIOl8oV3n5+pyfLq7ktUiLM3ZvuQw0+2POi1WyikZO0bgs16nqIxYppMLlqUcYL/FTqLRMVH0oq0GcgxXM3mu4KZs1fpRIlsIx3XIkQy9KSNL1TfSc8YRqo4OqdTi/KnJVqsiqUJtdqe+NhsLppuWSrWoUah2ZzZJm0Oi7kuFtDX/z0cfcf/CQvf1DqeO9+7vc231ITWt+0FA0xjhZYQ4dmRaRBL0/ZL5IJfskSWUN2s6YklKX1fDmMi8rolzTuK42GE+mG4a3++GzF3+SuRROfvbF/lY/lGURRkyXoHb6FOq6nEWtZ+Ml4M/mGw1vAzruBN3sY5gWA9uR7G73Q+G0PZ3heHO0bp+OOWTkhYymsw9JeQ+4fvfx9rENGMxjlHaf85JKTm1xpTS5rGi0BhPJfouhABRD5HYz1jc/uQGchdiTgNE0pKn3Zf4dyXDTyX8G+DN+W4CeZCi69EVZ5bLcIFdt3WT5Fxn+b8CNhiJJtuw2uuzU4tpypr+eoef7TIOQvNqWSREalptiPdGptE3J/u6AySbLQ3tE/lqRdfj6PMtFrii7lMizyHIgsnwXQNGAo3hBNl/go493yZyesXdwyFHmlL39A+49eERda31Iyl0Yiixv+qEhV8aLXIl8WaXW7G73w19lShihtC0q7b5cwxs9R55rPWe729wVUGw5vCDkWqnxw8tXctWr1psydsHsDkm5DSj6YRTNcV2XJ18e8uSLfR7/4QknZ88Jw1AOUQk7Ivj/D1DsvgQzsQMTwx5PMAe2HI47ldsQcV/U4n8BMkqEtR627fkAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="hooks 라이프 사이클"
        title="hooks 라이프 사이클"
        src="/b-log/static/9152e8f90004c9cbcc9fd5182e206bbe/44c61/2022-06-06-11-38-50.png"
        srcset="/b-log/static/9152e8f90004c9cbcc9fd5182e206bbe/12f09/2022-06-06-11-38-50.png 148w,
/b-log/static/9152e8f90004c9cbcc9fd5182e206bbe/e4a3f/2022-06-06-11-38-50.png 295w,
/b-log/static/9152e8f90004c9cbcc9fd5182e206bbe/44c61/2022-06-06-11-38-50.png 485w"
        sizes="(max-width: 485px) 100vw, 485px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
    <figcaption class="gatsby-resp-image-figcaption">hooks 라이프 사이클</figcaption>
  </figure></p>
<p>hooks의 실행 순서는 다음과 같습니다. 그렇다면 build_docker.sh 실행 후 switch_docker.sh를 실행하게 되겠네요.</p>
<h1 id="nginx" style="position:relative;"><a href="#nginx" aria-label="nginx permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Nginx</h1>
<h2 id="설치-2" style="position:relative;"><a href="#%EC%84%A4%EC%B9%98-2" aria-label="설치 2 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>설치</h2>
<div class="gatsby-highlight" data-language="shell"><pre style="counter-reset: linenumber NaN" class="language-shell line-numbers"><code class="language-shell"><span class="token function">sudo</span> amazon-linux-extras <span class="token function">install</span> nginx1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span></span></pre></div>
<h2 id="설명-2" style="position:relative;"><a href="#%EC%84%A4%EB%AA%85-2" aria-label="설명 2 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>설명</h2>
<div class="gatsby-highlight" data-language="conf"><pre style="counter-reset: linenumber NaN" class="language-conf line-numbers"><code class="language-conf">http {
    # 요청을 전달할 주소들의 집합
    upstream backends {
        server localhost:3000;
        server localhost:3001;
    }

    server {
        listen       80;
        server_name  localhost;

        # / 로 들어온 요청을 upstream backend로 전달
        location / {
            proxy_pass http://backends;
        }
    }
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>생각해보면 이상하지 않나요? 블루와 그린은 각각 3000, 3001 포트에서 실행되고 있는데 사용자는 대체 어떻게 접근해야 할까요? 두 포트를 던져주고 하나 안되면 다른 걸로 접속하라고 해야 할까요? 매력적인 제안이지만 안타깝게도 그건 진정한 무중단 배포라고 볼 수 없습니다.</p>
<p>Nginx가 등장할 차례입니다. Nginx는 리버스 프록시 기능을 제공합니다. 외부에서 특정 주소로 들어온 요청을 다른 곳으로 보내줄 수 있습니다. 이 과정에서 로드 밸런서의 역할도 겸합니다. 따로 설정을 안해줬으니 Nginx은 라운드로빈 방식으로 요청을 전달합니다. 한 번은 localhost:3000에, 한 번은 localhost:3001에 말이죠.</p>
<p>한 번 블루에서 서비스가 실행되고 있는 상태에서 새로운 배포가 들어와 그린을 실행 시키고 블루가 꺼지는 상황을 생각해 보겠습니다.</p>
<ol>
<li>Nginx는 블루로 요청을 전달하고 있습니다</li>
<li>그린이 켜집니다</li>
<li>Nginx은 블루와 그린에 번갈아 요청을 전달합니다</li>
<li>블루가 꺼집니다</li>
<li>Nginx는 이제 그린에만 요청을 전달합니다</li>
</ol>
<p>이제 사용자는 하나의 주소에 접속해도 항상 성공적으로 서비스에 접근할 수 있습니다.</p>
<h1 id="마무리" style="position:relative;"><a href="#%EB%A7%88%EB%AC%B4%EB%A6%AC" aria-label="마무리 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>마무리</h1>
<blockquote>
<p>🔭 <strong>Reference</strong> <a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check/">https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check/</a></p>
</blockquote>
<p>사실 삽질을 좀 많이 했습니다. 처음엔 S3에 코드를 업로드하지 않고 Github Actions에서 도커 이미지를 빌드한 다음에 도커 저장소에 푸시하고 배포 때 가져오는 걸 생각했었습니다. 그런 와중에 도전해보는 김에 싹 다 훑어보려고 S3에 업로드하는 방향으로 틀었는데 꽤 만족스럽네요. 몇 번 배포를 돌려보면서 S3에 zip이 좀 쌓였는데 그거 둘러보는 재미가 쏠쏠합니다.</p>
<p>사실 블루-그린 방식의 개념은 굉장히 쉽습니다. 원래 돌아가는 건 가만히 놔두고 다른 곳에 배포한 다음에 바꿔치기하면 완전 무중단 배포 아니에요? 맞습니다. 그게 무중단 배포죠!
그러나 언제나 그렇듯이 실제 구현으로 가는 길은 과속 방지턱이 잔뜩 박혀있습니다. 글로 정리하면 생각보다 짧은 과정인데 실제는 시간이 꽤 걸린 것 처럼요.
한 번은 실마리가 보여서 엑셀을 잔뜩 밟은 적도 있는데 꽤 혼났습니다. 과속 방지턱이 역시 무섭긴 무섭습니다.</p>
<p>Health Check에 대한 것도 말하지 않을 수 없네요. Nginx Open Source는 Passive Health Check만 지원합니다. 외부에서 요청이 들어왔을 때만 Health Check가 가능하죠. 일정 주기로 확인해주는 Active Health Check는 Nginx Plus에서만 제공됩니다.
Active Health Check에 대해 진지하게 생각하고 있다면 Nginx Plus를 결제하거나 처음부터 해당 기능을 지원하는 HAProxy를 찾아보세요.</p>
<p>그렇습니다. 생각보다 말이 길어졌네요. 이 글이 여러분들에게 도움이 됐으면 좋겠습니다. 그럼 이만!</p></section></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/CICD를 이용한 무중단 배포는 어떻게 해야 할까요/";window.___webpackCompilationHash="fae867cc0ea84673653c";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-9b448caf838dbc18971d.js"],"app":["/app-423680434a9201db7ee2.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-1013cbdf27b7225f497f.js"],"component---src-pages-index-js":["/component---src-pages-index-js-d79b3eb9493dac81784f.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-549bf8357642c940d19b.js"],"component---src-templates-tag-page-js":["/component---src-templates-tag-page-js-407c8a7c33abc6ac453d.js"]};/*]]>*/</script><script src="/b-log/polyfill-9b448caf838dbc18971d.js" nomodule=""></script><script src="/b-log/component---src-templates-blog-post-js-549bf8357642c940d19b.js" async=""></script><script src="/b-log/8c818aafd19f020a43cdd28cb6a1c8df7d18c0d2-0fdccc7611a7c55272d7.js" async=""></script><script src="/b-log/app-423680434a9201db7ee2.js" async=""></script><script src="/b-log/framework-2c67c8bfa55bfd760b60.js" async=""></script><script src="/b-log/webpack-runtime-76465a399045a41f636f.js" async=""></script></body></html>